name: üêõ DEBUG Calendario FC Barcelona

on:
  workflow_dispatch:

jobs:
  debug-permisos:
    runs-on: ubuntu-latest

    # Prova amb i sense permisos
    permissions:
      contents: write

    steps:
      # PAS 1: Mostrar informaci√≥ del entorn
      - name: üîç Informaci√≥n del entorno
        run: |
          echo "=== INFORMACI√ìN DEL ENTORNO ==="
          echo "Fecha: $(date)"
          echo "Repositorio: $GITHUB_REPOSITORY"
          echo "Actor: $GITHUB_ACTOR"
          echo "Workflow: $GITHUB_WORKFLOW"
          echo "Token disponible: ${{ secrets.GITHUB_TOKEN != '' }}"
          echo "FCB_TOKEN disponible: ${{ secrets.FCB_TOKEN != '' }}"
          echo ""
          echo "=== VARIABLES GITHUB ==="
          env | grep -i github | sort

      # PAS 2: Checkout amb debug
      - name: ‚¨áÔ∏è Checkout con debug
        id: checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Traer todo el historial

      # PAS 3: Verificar estado del repositorio
      - name: üìä Estado del repositorio
        run: |
          echo "=== ESTADO DEL REPOSITORIO ==="
          git status
          echo ""
          echo "=== RAMA ACTUAL ==="
          git branch -a
          echo ""
          echo "=== REMOTES ==="
          git remote -v
          echo ""
          echo "=== √öLTIMOS COMMITS ==="
          git log --oneline -5
          echo ""
          echo "=== ARCHIVOS .ics ==="
          ls -la *.ics 2>/dev/null || echo "No hay archivos .ics"

      # PAS 4: Probar permisos de escritura
      - name: ‚úèÔ∏è Probar escritura b√°sica
        run: |
          echo "=== PRUEBA DE ESCRITURA ==="
          
          # Crear archivo de prueba
          echo "# Archivo de prueba - $(date)" > test-permisos.txt
          echo "Este archivo prueba los permisos de escritura" >> test-permisos.txt
          
          # Configurar git
          git config user.email "debug@test.com"
          git config user.name "Debug Bot"
          
          echo "‚úÖ Archivo creado"
          ls -la test-permisos.txt

      # PAS 5: Probar add y commit
      - name: üíæ Probar add/commit
        run: |
          echo "=== PRUEBA ADD/COMMIT ==="
          
          # Intentar agregar
          git add test-permisos.txt
          echo "‚úÖ Add exitoso"
          
          # Intentar commit
          if git commit -m "üß™ Test permisos $(date '+%H:%M:%S')" 2>&1; then
            echo "‚úÖ Commit exitoso"
          else
            echo "‚ùå Fall√≥ el commit"
            echo "Error output:"
            git commit -m "üß™ Test permisos $(date '+%H:%M:%S')" 2>&1 || true
          fi

      # PAS 6: Probar push con diferentes m√©todos
      - name: üì§ Probar PUSH (m√©todo 1)
        id: push1
        run: |
          echo "=== M√âTODO 1: Push normal ==="
          set +e  # No salir en error
          
          if git push origin HEAD 2>&1; then
            echo "‚úÖ Push exitoso (m√©todo 1)"
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Push fall√≥ (m√©todo 1)"
            echo "result=failed" >> $GITHUB_OUTPUT
          fi
          set -e

      - name: üì§ Probar PUSH (m√©todo 2)
        if: steps.push1.outputs.result == 'failed'
        run: |
          echo "=== M√âTODO 2: Push con URL espec√≠fica ==="
          echo "Intentando con URL directa..."
          
          # Obtener URL del repositorio
          REPO_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/$GITHUB_REPOSITORY.git"
          
          git push $REPO_URL HEAD:master 2>&1 || echo "‚ùå M√©todo 2 tambi√©n fall√≥"

      # PAS 7: Verificar archivo .ics si existe
      - name: üìÖ Verificar calendario existente
        run: |
          echo "=== VERIFICANDO CALENDARIO ==="
          
          if [ -f "barcelona.ics" ]; then
            echo "‚úÖ barcelona.ics existe"
            echo "Tama√±o: $(wc -l < barcelona.ics) l√≠neas"
            echo "√öltima modificaci√≥n: $(stat -c %y barcelona.ics)"
            
            # Ver contenido b√°sico
            echo ""
            echo "=== PRIMERAS 10 L√çNEAS ==="
            head -10 barcelona.ics
          else
            echo "‚ÑπÔ∏è No existe barcelona.ics en este momento"
          fi

      # PAS 8: Intentar generar calendario
      - name: üêç Intentar generar calendario
        run: |
          echo "=== INTENTANDO GENERAR CALENDARIO ==="
          
          # Verificar si existe el script
          if [ -f "generate_calendar.py" ]; then
            echo "‚úÖ Script encontrado: generate_calendar.py"
            
            # Instalar dependencias si es necesario
            python -c "import requests" 2>/dev/null || pip install requests --quiet
            
            # Ejecutar script
            python generate_calendar.py
            
            # Verificar resultado
            if [ -f "barcelona.ics" ]; then
              echo "‚úÖ Calendario generado exitosamente"
              ls -la barcelona.ics
            else
              echo "‚ùå El script no gener√≥ barcelona.ics"
            fi
          elif [ -f "barcelona-calendar.py" ]; then
            echo "‚úÖ Script encontrado: barcelona-calendar.py"
            # ... mismo proceso
          else
            echo "‚ùå No se encontr√≥ ning√∫n script de generaci√≥n"
            echo "Archivos Python disponibles:"
            ls *.py 2>/dev/null || echo "No hay archivos .py"
          fi